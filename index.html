<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Login App</title>
    <script id="env-config" type="application/json">__ENV_CONFIG__</script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        background: #f6f8fa;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        min-height: 100vh;
        margin: 0;
      }

      main {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.08);
        padding: 2.5rem 3rem;
        max-width: 420px;
        width: 100%;
        text-align: center;
      }

      h1 {
        margin-bottom: 1rem;
        color: #1a202c;
      }

      p {
        color: #4a5568;
        line-height: 1.5;
      }

      pre {
        background: #edf2f7;
        border-radius: 8px;
        padding: 1rem;
        text-align: left;
        overflow-x: auto;
      }

      #user-info {
        margin-top: 1.5rem;
        display: none;
      }

      #loading-indicator {
        margin-top: 1rem;
        color: #2b6cb0;
        display: none;
      }

      .error {
        margin-top: 1rem;
        color: #c53030;
      }
    </style>
  </head>
  <body>
    <main>
      <h1>Google Sign-In Demo</h1>
      <p>
        Click the button below to sign in with Google. After you authorize, your ID
        token will be sent to the Express backend for verification.
      </p>

      <div id="google-signin-btn"></div>

      <div id="loading-indicator" role="status" aria-live="polite">
        Verifying your Google sessionâ€¦
      </div>

      <section id="user-info">
        <h2>Verified User</h2>
        <pre id="user-data"></pre>
      </section>

      <section id="error-message" class="error" role="alert"></section>
    </main>

    <script>
      const resultContainer = document.getElementById('user-info');
      const resultPre = document.getElementById('user-data');
      const errorContainer = document.getElementById('error-message');
      const loadingIndicator = document.getElementById('loading-indicator');

      function setError(message) {
        if (message) {
          errorContainer.textContent = message;
          errorContainer.style.display = 'block';
        } else {
          errorContainer.textContent = '';
          errorContainer.style.display = 'none';
        }
      }

      function hideLoading() {
        loadingIndicator.style.display = 'none';
      }

      async function handleCredentialResponse(response) {
        resultContainer.style.display = 'none';
        resultPre.textContent = '';
        setError('');

        if (!response || !response.credential) {
          setError('Google did not return a credential. Please try again.');
          return;
        }

        loadingIndicator.style.display = 'block';

        try {
          const res = await fetch('/api/auth/google', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({ credential: response.credential }),
          });

          const data = await res.json();

          if (!res.ok) {
            const message =
              data?.error === 'Invalid or expired ID token'
                ? 'Your Google session is invalid or has expired. Please sign in again.'
                : data?.error || 'Failed to verify your Google credential.';
            throw new Error(message);
          }

          resultPre.textContent = JSON.stringify(data.profile, null, 2);
          resultContainer.style.display = 'block';
        } catch (err) {
          console.error(err);
          setError(err.message);
        } finally {
          hideLoading();
        }
      }

      (function initClientId() {
        try {
          const configEl = document.getElementById('env-config');
          if (!configEl) {
            throw new Error('Environment configuration was not injected.');
          }

          const config = JSON.parse(configEl.textContent || '{}');
          if (config.GOOGLE_CLIENT_ID) {
            window.GOOGLE_CLIENT_ID = config.GOOGLE_CLIENT_ID;
          } else {
            setError(
              'GOOGLE_CLIENT_ID is not configured. Set the environment variable on the server before trying again.'
            );
          }
        } catch (error) {
          console.error('Failed to read environment configuration:', error);
          setError(
            'Unable to load configuration from the server. Please check your deployment settings.'
          );
        }
      })();

      function initializeGoogleSignIn() {
        if (!window.GOOGLE_CLIENT_ID) {
          return;
        }

        if (!(window.google && window.google.accounts && window.google.accounts.id)) {
          setError('Google Identity Services failed to load. Please refresh and try again.');
          return;
        }

        window.google.accounts.id.initialize({
          client_id: window.GOOGLE_CLIENT_ID,
          callback: handleCredentialResponse,
          ux_mode: 'popup',
          context: 'signin',
        });

        window.google.accounts.id.renderButton(document.getElementById('google-signin-btn'), {
          type: 'standard',
          shape: 'rectangular',
          theme: 'outline',
          text: 'signin_with',
          size: 'large',
          logo_alignment: 'left',
        });
      }

      if (document.readyState === 'complete') {
        initializeGoogleSignIn();
      } else {
        window.addEventListener('load', initializeGoogleSignIn);
      }
    </script>
  </body>
</html>
